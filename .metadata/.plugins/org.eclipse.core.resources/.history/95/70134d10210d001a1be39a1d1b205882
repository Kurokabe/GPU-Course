
#include "Bandwidth.h"

#include <iostream>
#include <assert.h>

#include "Device.h"
#include "Chrono.h"


using std::cout;
using std::endl;

 /*---------------------------------------------------------------------*\
 |*			Declaration 					*|
 \*---------------------------------------------------------------------*/

/*--------------------------------------*\
 |*		Imported	 	*|
 \*-------------------------------------*/

extern __global__ void kernelBandwidth(int* tabDataGM, int* tabFrequenceGM, int n, int dataMax);

 /*----------------------------------------------------------------------*\
 |*			Implementation 					*|
 \*---------------------------------------------------------------------*/

 /*-------------------------------------*\
 |*		Constructeur		*|
 \*-------------------------------------*/

Bandwidth::Bandwidth(const Grid& grid, int* tabData, int n, TransferType type) : n(n), type(type)
    {

    this->dg = grid.dg;
    this->db = grid.db;

    this->sizeTabDataGM = sizeof(int) * n; // [octet]

    switch (type)
	{
	case TransferType::HostToDevice:
	    Device::malloc(&tabDataGM, sizeTabDataGM);
	break;
	case TransferType::HostToDeviceDMA:
	    Device::hostMalloc(&tabDataGM, sizeTabDataGM, HostMemoryType::PRIORITYDEVICE);
	case TransferType::DeviceToDevice:
	    Device::malloc(&tabDataGM, sizeTabDataGM);
	    Device::malloc(&tabDataGMCopy, sizeTabDataGM);
	break;
	}


    Chrono chrono;
    switch (type)
    	{
    	case TransferType::HostToDevice:
    	case TransferType::HostToDeviceDMA:
	    Device::memcpyHToD(tabDataGM, tabData, sizeTabDataGM);
	    break;
    	case TransferType::DeviceToDevice:
	    Device::memcpyDToD(tabDataGMCopy, tabDataGM, sizeTabDataGM);
    	break;
    	}

    chrono.stop();

    elapsedTime = chrono.getElapseTimeS();
    cout << "Elapsed time : " << elapsedTime << " (s)" << endl;

    }

Bandwidth::~Bandwidth(void)
    {

    switch (type)
    	{
    	case TransferType::HostToDevice:
    	    Device::free (tabDataGM);
    	break;
    	case TransferType::HostToDeviceDMA:
    	    Device::hostFree(tabDataGM);
    	break;
    	case TransferType::DeviceToDevice:
    	    Device::free (tabDataGM);
	    Device::free(tabDataGMCopy);
	    break;
    	}
    }

double Bandwidth::getElapsedTime()
    {
    return elapsedTime;
    }

 /*-------------------------------------*\
 |*		Methode			*|
 \*-------------------------------------*/

void Bandwidth::run()
    {
    //kernelHistogramme<<<dg,db>>>(tabDataGM);
    //Device::memcpyDToH(tabData, tabDataGM);
    }

 /*---------------------------------------------------------------------*\
 |*			End	 					*|
 \*---------------------------------------------------------------------*/
